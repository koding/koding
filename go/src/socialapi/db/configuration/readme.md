## Set SHMAX var
The SHMMAX variable controls the maximum amount of memory to be allocated for shared memory use. If you try to assign high values for e.g. the shared_buffers GUC in PostgreSQL without adjusting SHMMAX, you might see an error message in Postgres' log like " ... Failed system call was shmget ... usually means that PostgreSQL's request for a shared memory segment exceeded your kernel's SHMMAX parameter", and you'll have to adjust SHMMAX upward accordingly.

# Set shared memory max limit to 16GB
sysctl -w kernel.shmmax=17179869184
# Set shared memory min limit to 4MB
sysctl -w kernel.shmall=4194304


ps: make sure to add them to `/etc/sysctl.conf`
kernel.shmmax = 1073741824
kernel.shmall = 536870912


## Set Max open file descriptor
cat /proc/sys/fs/file-max
be sure it has more than 90K
as of writing it is
root@postgre0:~# cat /proc/sys/fs/file-max
2438914

#Set max open file descriptor
sysctl -w fs.file-max = 2438914

to set permenantly add it to `/etc/sysctl.conf`
fs.file-max = 2438914


# benchmarking
postgres@postgre0.sj.koding.com: /root$ pgbench -S -c 64 -j 8 -T 60 koding_social
starting vacuum...end.
transaction type: SELECT only
scaling factor: 1
query mode: simple
number of clients: 64
number of threads: 8
duration: 60 s
number of transactions actually processed: 3401530
tps = 56673.062177 (including connections establishing)
tps = 56747.809904 (excluding connections establishing)

-c should not be greater than the -s
-c should be multiple of -j
pgbench -c 16 -j 8 -r -s 32 -l -T 120  koding_social


## Installing Postgresql
Create the file `/etc/apt/sources.list.d/pgdg.list`, and add a line for the repository

`deb http://apt.postgresql.org/pub/repos/apt/ precise-pgdg main`

Import the repository signing key, and update the package lists

```
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | \
  sudo apt-key add -
sudo apt-get update
```


now install  `apt-get install postgresql-9.3 `

then install `apt-get install postgresql-contrib`

# Set env variable for postgres binaries
```
$ cd ~
$ vim .profile
PATH=$PATH:/usr/lib/postgresql/9.3/bin
export PATH
$ . ~/.profile

```


## Configure
# 1 Allow replication requests

open /etc/postgresql/9.3/main/pg_hba.conf

```
host     replication     all             172.16.3.20/24         trust
```
add those lines to the end of the file


# 2 Allow Connections from outside

open /etc/postgresql/9.3/main/pg_hba.conf

```
host     all             all             172.16.3.21/24         password
```
add those lines to the end of the file


# 3 Change data directory

open /etc/postgresql/9.3/main/postgresql.conf

```
data_directory = '/data/postgresql/data'
```
replace with this line


# 4 Update connection settings

open /etc/postgresql/9.3/main/postgresql.conf

```
listen_addresses = '*'                  # what IP address(es) to listen on;
```
replace with this line (listen all)


# 5 Update Resource usage settings

open /etc/postgresql/9.3/main/postgresql.conf

```
# Specifies the amount of memory to be used by internal
# sort operations and hash tables before switching to
# temporary disk files. The total memory used could be
# many times the value of work_mem
# it is necessary to keep this fact in mind when choosing the value.
# Sort operations are used for ORDER BY, DISTINCT, and merge joins.
# The recommended range for this value is
# the total available memory / (2 * max_connections)
work_mem = 120MB

# Specifies the maximum amount of memory to be used in maintenance operations,
# such as VACUUM, CREATE INDEX, and ALTER TABLE ADD FOREIGN KEY.
# Larger settings may improve performance for vacuuming
# and for restoring database dumps.
# The recommended range for this value is 50MB per GB of the total available RAM.
maintenance_work_mem = 1408MB

# Sets the amount of memory the database
# server uses for shared memory buffers. The default is typically
# 32 megabytes and must be at least 128 kilobytes. The recommended
# range for this value is between 20%-30% of the total available RAM.
shared_buffers = 5632MB
```

# 6 Update WAL settings

open /etc/postgresql/9.3/main/postgresql.conf

```
wal_level = hot_standby

# The amount of memory used in shared memory for WAL data.
# The default is 64 kilobytes (64kB).
# The setting need only be large enough to hold
# the amount of WAL data generated by one typical transaction.
# The recommended range for this value is between 2-16MB.
wal_buffers = 16MB

// optimize for write
checkpoint_segments = 32
checkpoint_completion_target = 0.9
```


# 7 Update replication settings

open /etc/postgresql/9.3/main/postgresql.conf

```
max_wal_senders = 3
hot_standby = on
```



# 8 Update logging parameters

open /etc/postgresql/9.3/main/postgresql.conf

```
log_min_duration_statement = 10
log_checkpoints = on
log_checkpoints = on
log_connections = on
log_disconnections = on
log_hostname = on
log_line_prefix = '%m %u@%d %p %r '
log_lock_waits = on
```
# 9 Set client connection defaults

```
timezone = 'UTC'
```

# 10 Query Tuning

```
default_statistics_target = 100
# Sets the plannerâ€™s assumption about the effective size of the
# disk cache that is available to a single query. This is factored
# into estimates of the cost of using an index; a higher value
# makes it more likely index scans will be used, a lower
# value makes it more likely sequential scans will be used.
# The recommended range for this value is between 60%-80% of
# total available RAM
effective_cache_size = 16GB
```
