
worker_processes  5;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;

events { worker_connections  1024; }

# start http
http {

  # add global upstreams
  upstream kontrol {
  server 127.0.0.1:4000;

  }
  upstream kloud {
  server 127.0.0.1:5500;

  }
  upstream broker {
  server 127.0.0.1:8008;

  }
  upstream sourcemaps {
  server 127.0.0.1:3526;

  }
  upstream appsproxy {
  server 127.0.0.1:3500;

  }
  upstream webserver {
  server 127.0.0.1:3000;

  }
  upstream socialworker {
  server 127.0.0.1:3030;

  }
  upstream socialapi {
  server 127.0.0.1:7000;

  }


  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  gzip on;
  gzip_disable "msie6";

  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;

  # start server
  server {
    # do not add hostname here!
    listen 8080;
    root /usr/share/nginx/html;
    index index.html index.htm;
    location = /healthcheck {
      return 200;
      #access_log off;
    }


    location ~^/kontrol/.* {
      proxy_pass            http://kontrol;
      proxy_http_version    1.1;
      proxy_set_header      Upgrade         $http_upgrade;
      proxy_set_header      Connection      "upgrade";
      proxy_set_header      Host            $host;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }



    location ~^/kloud/.* {
      proxy_pass            http://kloud;
      proxy_http_version    1.1;
      proxy_set_header      Upgrade         $http_upgrade;
      proxy_set_header      Connection      "upgrade";
      proxy_set_header      Host            $host;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }



    location /websocket {
      proxy_pass            http://broker;
      proxy_http_version    1.1;
      proxy_set_header      Upgrade         $http_upgrade;
      proxy_set_header      Connection      "upgrade";
      proxy_set_header      Host            $host;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }



    location ~^/subscribe/.* {
      proxy_pass            http://broker;
      proxy_http_version    1.1;
      proxy_set_header      Upgrade         $http_upgrade;
      proxy_set_header      Connection      "upgrade";
      proxy_set_header      Host            $host;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }



    location /sourcemaps {
      proxy_pass            http://sourcemaps;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }



    location /appsproxy {
      proxy_pass            http://appsproxy;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }



    location / {
      proxy_pass            http://webserver;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }



    location /xhr {
      proxy_pass            http://socialworker;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }



    location /socialapi {
      proxy_pass            http://socialapi;
      proxy_set_header      X-Real-IP       $remote_addr;
      proxy_set_header      X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_next_upstream   error timeout   invalid_header http_500;
      proxy_connect_timeout 1;
    }


  # close server
  }
# close http
}
