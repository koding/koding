#!/usr/bin/env coffee

argv       = require('minimist')(process.argv.slice(2))
log        = console.log
fs         = require 'fs'
os         = require 'os'
request    = require 'request'

log "-------------------------"
log ""
log "# ./configure assumes development environment - comes bundled with options below."
log "# override them as you see fit with command line arguments like --config --branch etc."
log ""


version = try (fs.readFileSync (require 'path').join(__dirname, './VERSION'), 'utf-8').trim()

options = o =
  projectRoot      : argv.projectRoot    or __dirname
  config           : argv.config         or "dev"
  region           : argv.region         or "dev"
  branch           : argv.branch         or "cake-rewrite"
  build            : argv.build          or 1
  version          : argv.version        or                 version or "1.0"
  tag              : argv.tag            or                 version or "1.0"
  environment      : argv.environment    or "dev"
  publicPort       : argv.publicPort     or "8090"
  target           : argv.target         or "localhost"
  onlyconfigure    : argv.onlyconfigure  or no
  supervisor       : argv.supervisor     or no
  deploy           : argv.deploy         or no


rest = ->
  options.publicHostname = argv.publichostname or "http://#{options.hostname}:8090"



  log "Configuring with options:"
  log "-------------------------"
  log o
  log "-------------------------"
  log ""

  KONFIG = require("./config/main.#{o.config}.coffee")(options)


  createRunFile = (KONFIG)->

    fs.writeFileSync "run",KONFIG.runFile
    fs.chmodSync "./run", 0o755

    # write supervisor config
    if o.supervisor
      fs.writeFileSync "/etc/supervisor/conf.d/koding.conf",KONFIG.supervisorConf

    log "Configuration done"
    log "------------------"
    log "MAC INSTALL INSTRUCTIONS"
    log "------------------"
    log "1) install Docker, do `boot2docker init`, `boot2docker up`"
    log "2) export DOCKER_HOST as tcp://192.168.59.103:2375"
    log "3) brew install mongodb nginx"
    log "4) do './run install' "
    log "5) do './run buildservices' to create backend service containers after installing docker."
    log "6) you can then type './run' to run Koding and see it on #{o.hostname} and on koding-#{options.publicHostname}.ngrok.com"



  createRunFile KONFIG



if argv.hostname
  options.hostname       = argv.hostname
  rest()
else if os.type() is "Darwin"
  options.hostname = "lvh.me"
  rest()
else
  log "lemme find your IP"
  request "http://echoip.net",(err,res,body)->
      ip = body
      options.hostname = ip
      log "my ip is #{ip}"
      rest()
