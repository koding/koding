ModelLoader = require './modelloader'
{dash} = require 'sinkrow'

module.exports = ->
  switch arguments.length
    when 2
      handleBatch.apply @, arguments
    when 3
      handleSingle.apply @, arguments
    else
      throw new Error 'Bongo#cacheable expects either 2 or 3 arguments.'

getModelLoader =do ->
  loading_ = {}
  (constructor, id)->
    loading_[constructor.name] or= {}
    loader = loading_[constructor.name][id] or= new ModelLoader(constructor, id)

handleSingle =(constructorName, _id, callback)->
  # TODO: this implementation sucks; reimplement.
  constructor =
    if 'string' is typeof constructorName
      @api[constructorName]
    else if 'function' is typeof constructorName
      constructorName
  unless constructor
    callback new Error "Unknown type #{constructorName}"
  else
    constructor.cache or= {}
    if model = constructor.cache[_id]
      callback null, model
    else getModelLoader(constructor, _id).load (err, model)->
      constructor.cache[_id] = model
      callback err, model
  return

handleBatch =(batch, callback)->
  models = []
  queue = batch.map (single, i)=>=>
    {name, type, constructorName, id} = single
    handleSingle.call @, type or name or constructorName, id, (err, model)->
      if err
        callback err
      else
        models[i] = model
        queue.fin()
  dash queue, -> callback null, models
  return
