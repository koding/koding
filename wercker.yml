box: koding/base@0.0.18
no-response-timeout: 10

build:
  steps:
    - add-ssh-key:
        keyname: DEPLOYMENT_KEY
    - script:
        name: setup git identity
        code: |
          git config --global user.email 'sysops@koding.com'
          git config --global user.name 'Koding Bot'
    - script:
        name: fetch pull requests
        code: |
          git config --add remote.origin.fetch '+refs/pull/*/head:refs/remotes/origin/pull/*'
          git fetch --force --quiet origin
    - script:
        name: set up koding deployment key
        code: |
          chmod 600 $KODING_DEPLOYMENT_KEY
deploy:
  steps:
    - script:
        name: deploy started
        code: |
          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "<$WERCKER_DEPLOY_URL|deploy> of $WERCKER_GIT_BRANCH started" "deploying" 5
    - create-file:
        name: write version file
        filename: $WERCKER_ROOT/VERSION
        content: ${WERCKER_GIT_COMMIT:0:8}
        overwrite: true
    - script:
        name: setup nvm
        code: |
          source $HOME/.nvm/nvm.sh
          nvm use 0.10.33
    - script:
        name: zip
        code: |
          cd $WERCKER_ROOT

          rm -fr client/.config.json
          ./configure --config $CONFIG --projectRoot /opt/koding
          rm -rf .git .build node_modules client/node_modules client/builder/node_modules client/landing/node_modules client/.sprites
          rm -rf go/bin go/pkg
          zip -q --symlinks -r $ARCHIVE .

          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "created deploy file $ARCHIVE" "deploying" 45

    - koding/eb-deploy@0.0.8:
        access-key: $S3_KEY_ID
        secret-key: $S3_KEY_SECRET
        app-name: koding
        env-name: $EB_ENV_NAME
        version-label: $ARCHIVE
        region: $EB_ENV_REGION
        s3-bucket: $S3_EB_DEPLOY-$EB_ENV_REGION
        s3-key: $ARCHIVE
    - script:
        name: notify-cebeci with eb trigger
        code: |
          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "triggered $EB_ENV_NAME EB" "deploying" 95

  after-steps:
    - jessefulton/slack-notify:
        subdomain: koding
        token: $SLACK_TOKEN
        channel: announce
        username: wercker
        icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
    - script:
        name: notify-cebeci with result
        code: |
          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "wercker is done with the <$WERCKER_DEPLOY_URL|deploy> of $WERCKER_GIT_BRANCH result: $WERCKER_RESULT" $WERCKER_RESULT 100
