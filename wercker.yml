box: koding/base@0.0.12

build:
  steps:
    - script:
        name: build go binaries
        code: go/build.sh

deploy:
  steps:
    - script:
        name: configure s3cmd (temporary workaround)
        code: |
          echo '[default]' > ~/.s3cfg
          echo "access_key=$S3_KEY_ID" >> ~/.s3cfg
          echo "secret_key=$S3_KEY_SECRET" >> ~/.s3cfg

    - script:
        name: package klient.deb
        code: |
          s3cmd get s3://$S3_KLIENTKITE/$KLIENT_CHANNEL/latest-version.txt version
          export OLDBUILDNO=$(cat version)
          export NEWBUILDNO=$(($OLDBUILDNO+1))
          echo "New version will be: $NEWBUILDNO"

          export GOPATH=$PWD/go
          go run go/package.go -a klient -e $KLIENT_CHANNEL -b $NEWBUILDNO
          go build -v -ldflags "-X koding/kites/klient/protocol.Version 0.1.$NEWBUILDNO -X koding/kites/klient/protocol.Environment development" koding/kites/klient
          gzip -N klient
          mv klient.gz klient-0.1.$NEWBUILDNO.gz

          rm -f version

    - script:
        name: sync with s3
        code: |
          s3cmd put *.deb  s3://$S3_KLIENTKITE/$KLIENT_CHANNEL/$NEWBUILDNO/
          s3cmd -P put *.gz  s3://$S3_KLIENTKITE/$KLIENT_CHANNEL/$NEWBUILDNO/

          s3cmd del --recursive s3://$S3_KLIENTKITE/$KLIENT_CHANNEL/latest/
          s3cmd put *.deb  s3://$S3_KLIENTKITE/$KLIENT_CHANNEL/latest/
          s3cmd -P put *.gz  s3://$S3_KLIENTKITE/$KLIENT_CHANNEL/latest/

          s3cmd del s3://$S3_KLIENTKITE/$KLIENT_CHANNEL/latest-version.txt
          echo $NEWBUILDNO > latest-version.txt
          s3cmd -P put latest-version.txt  s3://$S3_KLIENTKITE/$KLIENT_CHANNEL/latest-version.txt
