box: koding/base@0.0.14
services:
  - wercker/postgresql@0.0.4
  - wercker/rabbitmq@1.0.1
  - wercker/redis@0.0.8
  - wercker/mongodb@1.0.1

build:
  steps:
    - script:
        name: build started
        code: |
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH is in progress" "building" 10
    - script:
        name: npm install
        code: |
          npm cache clean
          npm set registry https://registry.npmjs.org/
          npm install
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH - npm install finished" "building" 50
    - script:
        name: npm install (submodules)
        code: |
          cd client/Framework && npm install && cd ../../
          cd client/landing && npm install && cd ../../
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH - npm install (submodules) finished" "building" 30
    - script:
        name: configure build
        code: ./configure --config $CONFIG --projectRoot /opt/koding
    - script:
        name: build client
        code: |
          sudo chown -R $USER ~/.npm
          ./run
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH - build client finished" "building" 35
    - script:
        name: build go binaries
        code: go/build.sh
    - script:
        name: build social api
        cwd: go/src/socialapi
        code: |
          make configure
          make install
          make build
    - script:
        name: build backend finished
        code: |
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH - build backend finished" "building" 40
    - script:
        name: testing backend started
        code: |
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH - test backend started" "building" 41
    - script:
        name: create postgresql tables
        cwd: go
        code: |
          src/socialapi/db/sql/definition/create-wercker.sh src/socialapi/db/sql
          bin/migrate -url "postgres://$WERCKER_POSTGRESQL_HOST:$WERCKER_POSTGRESQL_PORT/$WERCKER_POSTGRESQL_DATABASE?user=$WERCKER_POSTGRESQL_USERNAME&password=$WERCKER_POSTGRESQL_PASSWORD" -path "src/socialapi/db/sql/migrations" up
    - script:
        name: test social api
        code: |
          sudo -E scripts/wercker/init-socialapi.sh
          tail -n 100 /var/log/koding/social-api.log
          tail -n 100 /var/log/koding/social-populartopic.log
          tail -n 100 /var/log/koding/social-pinnedpost.log
          cd go/src/socialapi
          make testapi config=./config/test.toml
    - script:
        name: testing backend finished
        code: |
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH - test backend finished" "building" 45
    - script:
        name: testing client started
        code: |
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH - test client started" "building" 46
    - add-ssh-key:
        keyname: DEPLOYMENT_KEY
    - script:
        name: set up koding deployment key
        code: |
          chmod 600 $KODING_DEPLOYMENT_KEY
    - script:
        name: fetch pull requests
        code: |
          git config --add remote.origin.fetch '+refs/pull/*/head:refs/remotes/origin/pull/*'
          git fetch --quiet origin
    - mktemp:
        envvar: GIT_REF
    - script:
        name: get git ref
        code: |
          REMOTE_BRANCH=$(git branch -r -v | grep ${WERCKER_GIT_COMMIT:0:7} | awk '{print $1}')
          echo $REMOTE_BRANCH
          scripts/wercker/get-gitref $REMOTE_BRANCH > $GIT_REF
    - mktemp:
        envvar: INSTANCE_DATA
    - mktemp:
        envvar: INSTANCE_IP
    - script:
        name: launch test instance
        code: |
          scripts/wercker/launch-test-instance --gitref "$(cat $GIT_REF)" | tail -n1 > $INSTANCE_DATA
          cat $INSTANCE_DATA
          HOST=$(cat $INSTANCE_DATA | awk '{print $2}')
          echo $HOST > $INSTANCE_IP
          if [ -z "$HOST)" ]; then exit 1; fi
          scripts/wercker/check-connectivity $HOST 8090 1m 3
          scripts/wercker/check-connectivity $HOST 4444 1m 2
          sleep 120
          scripts/notify-cebeci.sh "build" ${WERCKER_GIT_COMMIT:0:8} "test client in progress" "testing" 65
    - script:
        name: run login test suite
        code: |
          ssh -o 'StrictHostKeyChecking no' -i $KODING_DEPLOYMENT_KEY -l ubuntu $(cat $INSTANCE_IP) 'sudo /opt/koding/tests/test login'
    - script:
        name: run activity test suite
        code: |
          ssh -o 'StrictHostKeyChecking no' -i $KODING_DEPLOYMENT_KEY -l ubuntu $(cat $INSTANCE_IP) 'sudo /opt/koding/tests/test activity'
    - script:
        name: testing client finished
        code: |
          scripts/notify-cebeci.sh "BUILD_STARTED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH - test client finished" "building" 85
  after-steps:
    - script:
        name: output social api logs if fails
        code: |
          if [ "$WERCKER_RESULT" = "failed" ]; then
            tail -n 10000 /var/log/koding/social-api.log
          fi
    - script:
        name: terminate test instance
        code: |
          INSTANCE_ID=$(cat $INSTANCE_DATA | awk '{print $1}')
          scripts/wercker/terminate-test-instance $INSTANCE_ID
    - jessefulton/slack-notify:
        subdomain: koding
        token: $SLACK_TOKEN
        channel: announce
        username: wercker
        icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
    - script:
        name: build finished
        code: |
          scripts/notify-cebeci.sh "BUILD_FINISHED" "<$WERCKER_BUILD_URL|build> of $WERCKER_GIT_BRANCH is $WERCKER_RESULT " $WERCKER_RESULT 100
deploy:
  steps:
    - script:
        name: deploy started
        code: |
          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "<$WERCKER_DEPLOY_URL|deploy> of $WERCKER_GIT_BRANCH started" "deploying" 5
    - create-file:
        name: write version file
        filename: $WERCKER_ROOT/VERSION
        content: ${WERCKER_GIT_COMMIT:0:8}
        overwrite: true
    - script:
        name: zip
        code: |
          cd $WERCKER_ROOT

          ./configure --config $CONFIG --projectRoot /opt/koding
          ./run

          rm -rf .git .build node_modules
          rm -rf go/bin go/pkg
          rm -rf website/a/js/*.map
          zip -q --symlinks -r $ARCHIVE .

          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "created deploy file $ARCHIVE" "deploying" 45

    - koding/s3put@0.0.3:
        key-id: $S3_KEY_ID
        key-secret: $S3_KEY_SECRET
        file: $ARCHIVE
        url: s3://$S3_EB_DEPLOY
    - script:
        name: notify-cebeci with s3 upload
        code: |
          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "deployed the files to s3 s3://$S3_EB_DEPLOY/$ARCHIVE" "deploying" 75

    - koding/eb-deploy@0.0.5:
        access-key: $S3_KEY_ID
        secret-key: $S3_KEY_SECRET
        app-name: koding
        env-name: $EB_ENV_NAME
        app-location: $S3_EB_DEPLOY/$ARCHIVE
        version-label: $ARCHIVE
    - script:
        name: notify-cebeci with eb trigger
        code: |
          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "triggered $EB_ENV_NAME EB" "deploying" 95

  after-steps:
    - jessefulton/slack-notify:
        subdomain: koding
        token: $SLACK_TOKEN
        channel: announce
        username: wercker
        icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
    - script:
        name: notify-cebeci with result
        code: |
          $WERCKER_ROOT/scripts/notify-cebeci.sh "deploy" "wercker is done with the <$WERCKER_DEPLOY_URL|deploy> of $WERCKER_GIT_BRANCH" $WERCKER_RESULT 100
