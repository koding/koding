box: koding/base@0.0.11
services:
  - wercker/postgresql@0.0.4
  - wercker/rabbitmq@1.0.1
  - wercker/redis@0.0.8
  - wercker/mongodb@1.0.1

build:
  steps:
    - script:
        name: initialize submodules
        code: git submodule update --init --recursive
    - script:
        name: npm install
        code: |
          npm set registry https://registry.npmjs.org/
          npm install || :
    - script:
        name: configure build
        code: ./configure
    - script:
        name: build client
        code: ./run buildclient
    - script:
        name: build go binaries
        code: go/build.sh
    - script:
        name: build social api
        cwd: go/src/socialapi
        code: |
          make configure
          make install
          make build
    - script:
        name: create postgresql tables
        cwd: go/src/socialapi/db/sql
        code: definition/create-wercker.sh .
    - script:
        name: test social api
        code: |
          sudo -E scripts/wercker/init-socialapi.sh
          tail -n 100 /var/log/koding/social-api.log
          tail -n 100 /var/log/koding/social-populartopic.log
          tail -n 100 /var/log/koding/social-pinnedpost.log
          cd go/src/socialapi
          make testapi
  after-steps:
    - jessefulton/slack-notify:
        subdomain: koding
        token: $SLACK_TOKEN
        channel: announce
        username: wercker
        icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140

deploy:
  steps:
    - script:
        name: create $HOME/.ssh directory
        code: mkdir -p $HOME/.ssh
    - create-file:
        name: write private key
        filename: $HOME/.ssh/id_rsa
        content: $KEY_PRIVATE
        overwrite: true
        hide-from-log: true
    - create-file:
        name: write public key
        filename: $HOME/.ssh/id_rsa.pub
        content: $KEY_PUBLIC
        overwrite: true
        hide-from-log: false
    - create-file:
        name: create ssh configuration
        filename: $HOME/.ssh/config
        content: |-
          Host github.com
            User git
            IdentityFile ~/.ssh/id_rsa
    - create-file:
        name: write version file
        filename: $WERCKER_ROOT/VERSION
        content: $(git log -1 --format=%h)
        overwrite: true
    - script:
        name: deploy
        code: |
          chmod 600 $HOME/.ssh/id_rsa
          chmod 644 $HOME/.ssh/id_rsa.pub
          git config --global user.email "wercker@koding.com"
          git config --global user.name "wercker-build-box"
          git fetch --tags
          ./deploy --deploy --config=$CONFIG
    - script:
        name: zip
        code: |
          TODAY=$(date "+%Y-%m-%dT%H:%M:%S")
          export ZIPPED_FILENAME=${TODAY}_${WERCKER_GIT_COMMIT:0:8}.zip

          cd $WERCKER_ROOT
          rm -rf node_modules
          rm -rf .git
          rm -rf go/bin
          rm -rf go/pkg
          rm -rf .build

          zip -q --symlinks -r $ZIPPED_FILENAME .
    - koding/s3put@0.0.3:
          key-id: $S3_KEY_ID
          key-secret: $S3_KEY_SECRET
          file: $ZIPPED_FILENAME
          url: s3://$S3_EB_DEPLOY
    - koding/eb-deploy@0.0.3:
          access-key: $S3_KEY_ID
          secret-key: $S3_KEY_SECRET
          app-name: koding
          env-name: $EB_ENV_NAME
          app-location: $S3_EB_DEPLOY/$ZIPPED_FILENAME
          version-label: $ZIPPED_FILENAME
  after-steps:
    - jessefulton/slack-notify:
        subdomain: koding
        token: $SLACK_TOKEN
        channel: announce
        username: wercker
        icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
