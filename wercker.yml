box: koding/base@0.0.12

build:
  steps:
    - script:
        name: build go binaries
        code: go/build.sh

deploy:
  steps:
    - script:
        name: package klient.deb
        code: |
          export GOPATH=$PWD/go
          go run go/package.go -a klient -e development
          go build -v -ldflags "-X koding/kites/klient/protocol.Version 0.1.0 -X koding/kites/klient/protocol.Environment development" koding/kites/klient
          gzip -N klient
          mv klient.gz klient-0.1.0.gz

    - script:
        name: sync with s3
        code: |
          echo '[default]' > ~/.s3cfg
          echo "access_key=$S3_KEY_ID" >> ~/.s3cfg
          echo "secret_key=$S3_KEY_SECRET" >> ~/.s3cfg

          s3cmd get s3://S3_KLIENTKITE/latest-version.txt version
          export BUILDNO=$(cat version)

          s3cmd put *.deb  s3://S3_KLIENTKITE/$BUILDNO/
          s3cmd -P put *.gz  s3://S3_KLIENTKITE/$BUILDNO/

          s3cmd del --recursive s3://S3_KLIENTKITE/latest/
          s3cmd put *.deb  s3://S3_KLIENTKITE/latest/
          s3cmd -P put *.gz  s3://S3_KLIENTKITE/latest/

          s3cmd del s3://S3_KLIENTKITE/latest-version.txt
          echo $(($BUILDNO+1)) > latest-version.txt
          s3cmd -P put latest-version.txt  s3://S3_KLIENTKITE/latest-version.txt
