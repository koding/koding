{throttle} = require 'underscore'

###
@mixin: bongo "feed" mixin.
###
module.exports = do ->
  distributeFeed = (emitter, event)->
    queue = emitter.feedQueue[event]
    emitter.feedQueue[event] = []
    emitter.emit 'feed-'+event, queue
  
  appendToFeed:(model, event)->
    isLowQuality = model.getAt 'isLowQuality'
    return if isLowQuality
    constructor = @
    emitters = [constructor.getEmitter()]
    if encapsulatingConstructor = constructor.encapsulatedBy
      emitters.push encapsulatingConstructor.getEmitter()
    for emitter, i in emitters
      emitter.feedQueue or= {}
      queue = emitter.feedQueue[event] or= []
      queue.push model
      distributeFeed emitter, event
      constructor
