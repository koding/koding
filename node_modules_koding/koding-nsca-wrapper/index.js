var spawn   = require('child_process').spawn
  , argv    = require('optimist').argv
  , KONFIG  = require('koding-config-manager').load("main." + (argv.c || "vagrant"))
;

function formatCommand(component, severity, message) {
  return [
    require('os').hostname(),
    component,
    severity,
    message ? message.replace(/\t/g, ' ') : 'Severity updated'
  ].join('\t') + '\n';
}

function handlerOf(method) {
  return function (it) {
    console[method](String(it));
  }
}

exports.sendStatus = function (component, severity, message) {
  var p = spawn('/usr/local/nagios/bin/send_nsca', [
    '-H', KONFIG.opsview.host,
    '-c', "/usr/local/nagios/etc/send_nsca.cfg"
  ]);
  p.stderr.on('data', handlerOf('error'));
  p.stdout.on('data', handlerOf('log'));
  p.stdin.write(
    formatCommand(component, severity, message)
  );
  p.stdin.end();
};