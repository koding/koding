{ promisify, promisifyAll } = require 'bluebird'
generateSprites = promisify require 'node-sprite-generator'
fs = promisifyAll require 'fs'
{ join: joinPath, basename } = require 'path'

createStylusHelper = require './stylus-helper.coffee'
createStylusHandler = require './stylus-handler.coffee'

module.exports = (options, callback) ->
  options.retinaRe ?= /@2x$/
  options.destPath ?= ''

  dir = joinPath process.cwd(), options.srcPath

  fs.readdirAsync dir
    .map (item) -> joinPath dir, item
    .filter (path) ->
      (fs.statAsync path).then (stats) -> stats.isDirectory()
    .bind {}
    .map (path) ->
      isRetina = options.retinaRe.test path
      spriteName = basename path
      generateSprites
        src           : ["#{ path }/*.png"]
        spritePath    : joinPath options.destPath, "#{ spriteName }.sprite.png"
        layoutOptions : { padding: 1 }
        stylesheet    : createStylusHandler this, isRetina
    .then -> createStylusHelper this, options
    .nodeify callback
