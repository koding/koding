{ join: joinPath } = require 'path'
{ nodes: { Property, Unit } } = require 'stylus'

assertSprite = (name, sprite) ->
  throw new Error "missing sprite #{ name }"  unless sprite?

module.exports = (layouts, options) ->

  image: ({ string: name }, { string: image }, dimensions) ->
    dimensions = if dimensions then dimensions.val else yes
    sprite = layouts[name][image]
    assertSprite name, sprite

    { width, height, top, left } = sprite

    if dimensions
      widthNode = new Property ['width'], "#{ width }px"
      heightNode = new Property ['height'], "#{ height }px"
      @closestBlock.nodes.splice @closestBlock.index + 1, 0, widthNode, heightNode

    backgroundUrl = joinPath options.httpPath ? options.path, sprite.filename
    background = "url(#{ backgroundUrl }?#{ options.version }) #{ left }px -#{ top }px"

    new Property ['background'], background

  dimensions: ({ string: name }, { string: image }) ->
    sprite = layouts[name][image]
    assertSprite name, sprite

    { sprite: { width, height } } = sprite

    new Unit "#{width}px #{height}px"
