_  = require 'underscore'
traverse = require 'traverse'

KONFIG = {}

do ->
  unless 'first' of Array.prototype
    Object.defineProperty Array.prototype, 'first',
      get: -> this[0]
  unless 'last' of Array.prototype
    Object.defineProperty Array.prototype, 'last',
      get: -> this[this.length - 1]


try
  module.exports = KONFIG = JSON.parse process.env.KONFIG_JSON
catch err
  console.error 'error: could not parse KONFIG_JSON environment variable'
  console.error err
  process.exit 1

traverse.forEach KONFIG, (node) ->
  if val = process.env["KONFIG_#{this.path.join('_').toUpperCase()}"]
    try
      parsedVal = JSON.parse val
      if typeof node is typeof parsedVal
        val = parsedVal
      else if val is parsedVal.toString()
        val = parsedVal

  return if val? then val else node

KONFIG.getConfigScriptTag = (mixin = {}) ->
  config = _.extend {}, @client.runtimeOptions, mixin
  """
  <script>var KD = #{JSON.stringify { config } };</script>
  """
