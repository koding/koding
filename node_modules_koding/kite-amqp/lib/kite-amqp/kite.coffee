{EventEmitter} = require 'microemitter'
Kite = require './index'

module.exports = class KiteBase extends EventEmitter

  __createAmqpConfig = (res) ->

    config =
      amqp          :
        port        : 5672
        protocol    : "amqp:"
        vhost       : '/'
        heartbeat   : 10


    config.amqp.port      = res.port if res?.port?
    config.amqp.host      = res.host if res?.host?
    config.amqp.protocol  = res.protocol if res?.protocol?
    config.amqp.login     = res.username if res?.username?
    config.amqp.password  = res.password if res?.password?
    config.amqp.vhost     = res.vhost if res?.vhost?
    config.amqp.heartbeat = res.heartbeat if res?.heartbeat?

    return config

  constructor:(config, functions, roundRobin = false)->

    schema = config.apiAdress.split(":")[0]

    if schema == "https"
      client = require 'https'
    else
      client = require 'http'

    url = "#{config.apiAdress}/-/kite/login?key=#{config.key}&name=#{config.name}"

    client.get url, (res) =>
      unless res.statusCode == 200
        console.log 'You can not start this Kite'
        return

      data = ""

      res.on "data", (chunk) ->
        data += chunk

      res.on "end", ->
        data = JSON.parse data

        @config = __createAmqpConfig data
        console.log 'Kite has started'

        @kite = new Kite config.name, functions
        @kite.run @config

      res.on "error", (e) ->
        console.log "Cannot start Kite #{e.message}"
