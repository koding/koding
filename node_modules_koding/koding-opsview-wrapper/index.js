var spawn   = require('child_process').spawn
  , argv    = require('optimist').argv
  , KONFIG  = require('koding-config-manager').load("main." + (argv.c || "vagrant"))
;

function formatCommand(component, severity, message) {
  return [
    require('os').hostname(),
    component,
    severity,
    message ? message.replace(/\s+/g, ' ') : 'Severity updated'
  ].join('\t') + '\n';
}

function out(method) {
  return function (it) {
    console[method](String(it));
  };
}

exports.send = function (component, severity, message) {
  var ov = KONFIG.opsview
    , p
  ;
  if (!ov.bin) return;
  p = spawn(ov.bin, [
    '-H', ov.host,
    '-c', ov.conf
  ]);
  p.stderr.on('data', out('error'));
  p.stdout.on('data', out('log'));
  p.stdin.write(
    formatCommand(component, severity, message)
  );
  p.stdin.end();
};