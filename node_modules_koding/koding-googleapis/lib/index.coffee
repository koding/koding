google = require 'googleapis'

{argv} = require 'optimist'
KONFIG = require('koding-config-manager').load("main.#{argv.c}")


account = KONFIG.googleapiServiceAccount
email   = account.serviceAccountEmail
key     = account.serviceAccountKeyFile

{
  clientId
  clientSecret
} = account


oauth2Client = null
drive        = null


authorize = (options, callback) ->

  {scope, subject} = options

  scope ?= null

  return callback 'Subject is not specified'  unless subject

  subject = [subject]  if typeof subject is 'string'

  new google.auth.JWT email, key, scope, subject
    .authorize callback


authenticate = (options, callback) ->

  {access_token, refresh_token} = options

  return callback 'access_token is not specified'  unless access_token
  return callback 'refresh_token is not specified'  unless refresh_token

  oauth2Client = new google.auth.OAuth2 clientId, clientSecret, null
  oauth2Client.setCredentials options

  callback null, oauth2Client


authenticated = (options, method) ->

  {
    authorization_options
    authorization_handler
    authentication_handler
  } = options

  return ->

    method_arguments = arguments

    return method.apply null, method_arguments  if oauth2Client

    authorize authorization_options, (err, token) ->
      return console.error err  if err

      authorization_handler? token

      authenticate token, (err, client) ->
        return console.error err  if err

        authentication_handler? client

        method.apply null, method_arguments


module.exports = {
  authorize
  authenticate
  authenticated
}
