class Sequence
  constructor:(@fn, @cb) ->
    @times = 0
    @args = []

  next:(args) ->
    unless nextArgs = @args.shift()
      nextFn = @cb
    else
      nextFn = @next.bind this, nextArgs
    if @times--
      @fn.apply this, args.concat nextFn

  add:(args) ->
    unless @times++
      process.nextTick @next.bind this, args
    else
      @args.push args


{ slice } = []

module.exports = (fn, cb) ->
  sequence = new Sequence fn, cb
  ->
    sequence.add slice.call arguments
