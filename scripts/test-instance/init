#!/bin/bash

set -o errexit

HOST=$(ec2metadata | grep public-hostname | FS=':' awk '{print $2}')

export HOME=/root/
export DISPLAY=:99
export REPOSITORY_PATH='/opt/koding'

export CI="true"
export WERCKER="true"

export CONFIG_DEBUGMODE="true"

service nginx stop

ulimit -n 10240

cd $REPOSITORY_PATH

scripts/wercker/install-node-modules koding
scripts/install-npm.sh -u

./configure --host $HOST:8090
./run install

export TEST_EXTRAS="--no-start-selenium --url http://$HOST:8090"
make -C client/test build

docker run -d -p 5672:5672 -p 15672:15672 --name=rabbitmq koding/rabbitmq

./run services
./run migrate up
./run resetdb --yes
./run importusers

supervisord -c $REPOSITORY_PATH/supervisord.conf

sleep 60

Xvfb $DISPLAY -shmem -screen 0 1440x900x16 &
sleep 15

x11vnc -passwd secret -display $DISPLAY -N -forever &
sleep 10

export TEST_VENDOR=$REPOSITORY_PATH/client/test/vendor

java -jar $TEST_VENDOR/selenium-server-standalone-2.46.0.jar \
     -host 0.0.0.0 \
     -port 42424 \
     -Dwebdriver.chrome.driver=$TEST_VENDOR/chromedriver/linux64/chromedriver &

exit 0
