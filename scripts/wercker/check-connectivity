#!/bin/bash

INSTANCE_DATA_FILE=$1

SCRIPTS=$(dirname $0)/..

INSTANCES=$(cat $INSTANCE_DATA_FILE)

function terminate_instance () {
  INSTANCE_ID=$1
  $SCRIPTS/test-instance/terminate $INSTANCE_ID
}

function check () {
  INSTANCE=$1
  INSTANCE_ID=$(echo $INSTANCE | awk '{print $1}')
  HOST=$(echo $INSTANCE | awk '{print $2}')

  PORT=$2
  INTERVAL=$3
  TRY_COUNT=$4

  echo -en "$HOST:$PORT\t\t"
  $SCRIPTS/test-instance/check-connectivity $HOST $PORT $INTERVAL $TRY_COUNT
  EXIT_CODE=$?

  if [ $EXIT_CODE -ne 0 ]; then
    terminate_instance $INSTANCE_ID
  fi

  return $EXIT_CODE
}

rm -f $INSTANCE_DATA_FILE
touch $INSTANCE_DATA_FILE

IFS=$'\n'
for INSTANCE in $INSTANCES; do
  check $INSTANCE 8090 1m 1 || continue # nginx
  check $INSTANCE 4444 3m 1 || continue # selenium-server
  echo $INSTANCE >> $INSTANCE_DATA_FILE
  echo
done

INSTANCE_IDS=$(cat $INSTANCE_DATA_FILE | awk '{print $1}')
INSTANCE_COUNT=$(echo $INSTANCE_IDS | wc -l)

if [ $INSTANCE_COUNT -eq 0 ]; then
  exit 1
fi

echo $INSTANCE_IDS | xargs -n 1 $SCRIPTS/test-instance/protect

exit 0
